<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3Dキャラ スクロール連動</title>
  <style>
    body { margin: 0; height: 200vh; } /* スクロール領域 */
    canvas { display: block; }
    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 5px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.18"></script>
</head>
<body>
  <div id="debug">
    <div>Scroll: <span id="scrollProgress">0%</span></div>
    <div>Frame: <span id="currentFrame">0 / 24</span></div>
  </div>

  <script>
    let scene, camera, renderer, model, mixer, animationAction;
    let scrollY = 0, targetScrollY = 0;

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x202020);

      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.set(0, 1.5, 5); // ← GUIで調整対象
      camera.lookAt(0, 1, 0);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5, 10, 7.5);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0xffffff, 0.3));

      // モデル読み込み
      const loader = new THREE.GLTFLoader();
      loader.load("models/iori.glb", (gltf) => {
        model = gltf.scene;
        scene.add(model);

        mixer = new THREE.AnimationMixer(model);
        if (gltf.animations.length > 0) {
          animationAction = mixer.clipAction(gltf.animations[0]);
          animationAction.play();
          animationAction.paused = true; // 自動再生しない
        }
      });

      // スクロール監視
      window.addEventListener("scroll", () => {
        targetScrollY = window.scrollY;
      });

      // lil-guiでカメラ調整
      const gui = new lil.GUI();
      const camFolder = gui.addFolder("Camera");
      camFolder.add(camera.position, "x", -10, 10, 0.1);
      camFolder.add(camera.position, "y", -10, 10, 0.1);
      camFolder.add(camera.position, "z", -10, 10, 0.1);
      camFolder.open();

      window.addEventListener("resize", onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);

      scrollY += (targetScrollY - scrollY) * 0.1;
      const scrollProgress = Math.min(scrollY / (document.body.scrollHeight - window.innerHeight), 1);

      if (mixer && animationAction) {
        const duration = animationAction.getClip().duration;
        const time = scrollProgress * duration;
        animationAction.time = time;
        mixer.update(0);

        document.getElementById("scrollProgress").textContent = Math.round(scrollProgress * 100) + "%";
        document.getElementById("currentFrame").textContent = Math.round(scrollProgress * 24) + " / 24";
      }

      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
